{"version":3,"file":"color-scheme.js","sources":["../src/color-scheme.ts"],"sourcesContent":["import { waitForPromise } from '@ember/test-waiters';\n\nimport { cell } from 'ember-resources';\n\nconst _colorScheme = cell<string | undefined>();\n\nlet callbacks: Set<(colorScheme: string) => void> = new Set();\n\nasync function runCallbacks(theme: string) {\n  await Promise.resolve();\n\n  for (let callback of callbacks.values()) {\n    callback(theme);\n  }\n}\n\n/**\n * Object for managing the color scheme\n */\nexport const colorScheme = {\n  /**\n   * Set's the current color scheme to the passed value\n   */\n  update: (value: string) => {\n    colorScheme.current = value;\n\n    waitForPromise(runCallbacks(value));\n  },\n\n  on: {\n    /**\n     * register a function to be called when the color scheme changes.\n     */\n    update: (callback: (colorScheme: string) => void) => {\n      callbacks.add(callback);\n    },\n  },\n  off: {\n    /**\n     * unregister a function that would have been called when the color scheme changes.\n     */\n    update: (callback: (colorScheme: string) => void) => {\n      callbacks.delete(callback);\n    },\n  },\n\n  /**\n   * the current valuel of the \"color scheme\"\n   */\n  get current(): string | undefined {\n    return _colorScheme.current;\n  },\n  set current(value: string | undefined) {\n    _colorScheme.current = value;\n\n    if (!value) {\n      localPreference.delete();\n\n      return;\n    }\n\n    localPreference.update(value);\n    setColorScheme(value);\n  },\n};\n\n/**\n * Synchronizes state of `colorScheme` with the users preferences as well as reconciles with previously set theme in local storage.\n *\n * This may only be called once per app.\n */\nexport function sync() {\n  /**\n   * reset the callbacks\n   */\n  callbacks = new Set();\n\n  /**\n   * If local prefs are set, then we don't care what prefers-color-scheme is\n   */\n  if (localPreference.isSet()) {\n    let pref = localPreference.read();\n\n    if (pref === 'dark') {\n      setColorScheme('dark');\n\n      _colorScheme.current = 'dark';\n\n      return;\n    }\n\n    setColorScheme('light');\n    _colorScheme.current = 'light';\n\n    return;\n  }\n\n  if (prefers.dark()) {\n    setColorScheme('dark');\n    _colorScheme.current = 'dark';\n  } else if (prefers.light()) {\n    setColorScheme('light');\n    _colorScheme.current = 'light';\n  }\n}\n\n/**\n * Helper methods to determining what the user's preferred color scheme is\n */\nexport const prefers = {\n  dark: () => window.matchMedia('(prefers-color-scheme: dark)').matches,\n  light: () => window.matchMedia('(prefers-color-scheme: light)').matches,\n  custom: (name: string) => window.matchMedia(`(prefers-color-scheme: ${name})`).matches,\n  none: () => window.matchMedia('(prefers-color-scheme: no-preference)').matches,\n};\n\nconst LOCAL_PREF_KEY = 'ember-primitives/color-scheme#local-preference';\n\n/**\n * Helper methods for working with the color scheme preference in local storage\n */\nexport const localPreference = {\n  isSet: () => Boolean(localPreference.read()),\n  read: () => localStorage.getItem(LOCAL_PREF_KEY),\n  update: (value: string) => localStorage.setItem(LOCAL_PREF_KEY, value),\n  delete: () => localStorage.removeItem(LOCAL_PREF_KEY),\n};\n\n/**\n * For the given element, returns the `color-scheme` of that element.\n */\nexport function getColorScheme(element?: HTMLElement) {\n  let style = styleOf(element);\n\n  return style.getPropertyValue('color-scheme');\n}\n\nexport function setColorScheme(element: HTMLElement, value: string): void;\nexport function setColorScheme(value: string): void;\n\nexport function setColorScheme(...args: [string] | [HTMLElement, string]): void {\n  if (typeof args[0] === 'string') {\n    styleOf().setProperty('color-scheme', args[0]);\n\n    return;\n  }\n\n  if (typeof args[1] === 'string') {\n    styleOf(args[0]).setProperty('color-scheme', args[1]);\n\n    return;\n  }\n\n  throw new Error(`Invalid arity, expected up to 2 args, received ${args.length}`);\n}\n\n/**\n * Removes the `color-scheme` from the given element\n */\nexport function removeColorScheme(element?: HTMLElement) {\n  let style = styleOf(element);\n\n  style.removeProperty('color-scheme');\n}\n\nfunction styleOf(element?: HTMLElement) {\n  if (element) {\n    return element.style;\n  }\n\n  return document.documentElement.style;\n}\n"],"names":["_colorScheme","cell","callbacks","Set","runCallbacks","theme","Promise","resolve","callback","values","colorScheme","update","value","current","waitForPromise","on","add","off","delete","localPreference","setColorScheme","sync","isSet","pref","read","prefers","dark","light","window","matchMedia","matches","custom","name","none","LOCAL_PREF_KEY","Boolean","localStorage","getItem","setItem","removeItem","getColorScheme","element","style","styleOf","getPropertyValue","args","setProperty","Error","length","removeColorScheme","removeProperty","document","documentElement"],"mappings":"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"}