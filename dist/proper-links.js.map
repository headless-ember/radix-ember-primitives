{"version":3,"file":"proper-links.js","sources":["../src/proper-links.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\nimport { assert } from '@ember/debug';\nimport { registerDestructor } from '@ember/destroyable';\nimport { getOwner } from '@ember/owner';\n\nimport { getAnchor, shouldHandle } from 'should-handle-link';\n\nimport type EmberRouter from '@ember/routing/router';\nimport type RouterService from '@ember/routing/router-service';\n\nexport { shouldHandle } from 'should-handle-link';\n\ntype Constructor<T extends object = object> = { new (...args: any[]): T };\n\nexport interface Options {\n  ignore?: string[];\n}\n\nexport function properLinks(\n  options: Options\n): <Instance extends object, Klass = { new (...args: any[]): Instance }>(klass: Klass) => Klass;\n\nexport function properLinks<Instance extends object, Klass = { new (...args: any[]): Instance }>(\n  klass: Klass\n): Klass;\n/**\n * @internal\n */\nexport function properLinks<Instance extends object, Klass = { new (...args: any[]): Instance }>(\n  options: Options,\n  klass: Klass\n): Klass;\n\nexport function properLinks<Instance extends object, Klass = { new (...args: any[]): Instance }>(\n  ...args: [Options] | [Klass] | [Options, Klass]\n): Klass | ((klass: Klass) => Klass) {\n  let options: Options = {};\n\n  let klass: undefined | Klass = undefined;\n\n  if (args.length === 2) {\n    options = args[0] as Options;\n    klass = args[1] as Klass;\n  } else if (args.length === 1) {\n    if (typeof args[0] === 'object') {\n      // TODO: how to get first arg type correct?\n      return (klass: Klass) => properLinks(args[0] as any, klass);\n    } else {\n      klass = args[0];\n    }\n  }\n\n  let ignore = options.ignore || [];\n\n  assert(`klass was not defined. possibile incorrect arity given to properLinks`, klass);\n\n  return class RouterWithProperLinks extends (klass as unknown as Constructor<EmberRouter>) {\n    // SAFETY: we literally do not care about the args' type here,\n    //         because we just call super\n    constructor(...args: any[]) {\n      super(...args);\n\n      setup(this, ignore);\n    }\n  } as unknown as Klass;\n}\n\n/**\n * Setup proper links without a decorator.\n * This function only requires that a framework object with an owner is passed.\n */\nexport function setup(parent: object, ignore?: string[]) {\n  const handler = (event: MouseEvent) => {\n    /**\n     * event.target may not be an anchor,\n     * it may be a span, svg, img, or any number of elements nested in <a>...</a>\n     */\n    let interactive = getAnchor(event);\n\n    if (!interactive) return;\n\n    let owner = getOwner(parent);\n\n    assert('owner is not present', owner);\n\n    let routerService = owner.lookup('service:router');\n\n    handle(routerService, interactive, ignore ?? [], event);\n  };\n\n  document.body.addEventListener('click', handler, false);\n\n  registerDestructor(parent, () => document.body.removeEventListener('click', handler));\n}\n\nexport function handle(\n  router: RouterService,\n  element: HTMLAnchorElement,\n  ignore: string[],\n  event: MouseEvent\n) {\n  if (!shouldHandle(location.href, element, event, ignore)) {\n    return;\n  }\n\n  let url = new URL(element.href);\n\n  let fullHref = `${url.pathname}${url.search}${url.hash}`;\n\n  let rootURL = router.rootURL;\n\n  let withoutRootURL = fullHref.slice(rootURL.length);\n\n  // re-add the \"root\" sigil\n  // we removed it when we chopped off the rootURL,\n  // because the rootURL often has this attached to it as well\n  if (!withoutRootURL.startsWith('/')) {\n    withoutRootURL = `/${withoutRootURL}`;\n  }\n\n  try {\n    let routeInfo = router.recognize(fullHref);\n\n    if (routeInfo) {\n      event.preventDefault();\n      event.stopImmediatePropagation();\n      event.stopPropagation();\n\n      router.transitionTo(withoutRootURL);\n\n      return false;\n    }\n  } catch (e) {\n    if (e instanceof Error && e.name === 'UnrecognizedURLError') {\n      return;\n    }\n\n    throw e;\n  }\n}\n"],"names":["properLinks","args","options","klass","undefined","length","ignore","assert","RouterWithProperLinks","constructor","setup","parent","handler","event","interactive","getAnchor","owner","getOwner","routerService","lookup","handle","document","body","addEventListener","registerDestructor","removeEventListener","router","element","shouldHandle","location","href","url","URL","fullHref","pathname","search","hash","rootURL","withoutRootURL","slice","startsWith","routeInfo","recognize","preventDefault","stopImmediatePropagation","stopPropagation","transitionTo","e","Error","name"],"mappings":"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"}